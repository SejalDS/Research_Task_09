import json
from pathlib import Path
import numpy as np
import pandas as pd


def missingness_summary(df: pd.DataFrame) -> pd.DataFrame:
    return (
        df.isna()
        .sum()
        .to_frame("missing_count")
        .assign(missing_pct=lambda x: (x["missing_count"] / len(df) * 100).round(2))
        .sort_values("missing_pct", ascending=False)
    )


def text_inconsistencies(df: pd.DataFrame) -> pd.DataFrame:
    text_cols = df.select_dtypes(include=["object", "string"]).columns.tolist()
    rows = []

    for col in text_cols:
        s = df[col].dropna().astype(str)
        if s.empty:
            continue
        rows.append({
            "column": col,
            "unique_original": int(s.nunique()),
            "unique_lowercase": int(s.str.lower().nunique()),
            "pct_with_whitespace": round(float((s != s.str.strip()).mean() * 100), 2),
        })

    return pd.DataFrame(rows).sort_values(
        ["pct_with_whitespace", "unique_original"],
        ascending=[False, False]
    )


def temporal_coverage(df: pd.DataFrame) -> pd.DataFrame:
    dt_cols = [c for c in df.columns if c.endswith("_dt")]
    rows = []

    for c in dt_cols:
        s = df[c]
        if s.notna().sum() == 0:
            continue
        rows.append({
            "column": c,
            "non_null": int(s.notna().sum()),
            "min": str(s.min()),
            "max": str(s.max()),
            "pct_parseable": round(float(s.notna().mean() * 100), 2),
        })

    return pd.DataFrame(rows)


def numeric_summary(df: pd.DataFrame) -> pd.DataFrame:
    return df.describe(include=[np.number]).T


def full_summary(df: pd.DataFrame) -> pd.DataFrame:
    return df.describe(include="all").T


def ground_truth_findings(df: pd.DataFrame) -> dict:
    ms = missingness_summary(df)

    return {
        "total_records": int(len(df)),
        "most_missing_column": str(ms.index[0]) if len(ms) else None,
        "most_missing_pct": float(ms.iloc[0]["missing_pct"]) if len(ms) else None,
    }


def save_json(obj, outpath):
    outpath = Path(outpath)
    outpath.write_text(json.dumps(obj, indent=2), encoding="utf-8")
